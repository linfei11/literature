# Finding Phish in a Haystack: A Pipeline for Phishing Classification on Certificate Transparency Logs

> 海量数据的网络钓鱼检测：证书透明日志上的网络钓鱼分类管道

## 1.背景

### （1）期刊/会议级别

arXiv预印本网站 2016.12343 【cs.CR】 

接收于第16届可用性、可靠性和安全性国际会议(ARES 2021)

级别：CCF None

![image-20210715182533428](Finding Phish in a Haystack A Pipeline for Phishing Classification on Certificate Transparency Logs.assets/image-20210715182533428.png)

### （2）作者团队

Arthur Drichel，Vincent Drury，Justus von Brandt，Ulrike Meyer四位作者都来自德国 **亚琛工业大学**

只找到Ulrike Meyer的信息如下：

![image-20210715184059001](Finding Phish in a Haystack A Pipeline for Phishing Classification on Certificate Transparency Logs.assets/image-20210715184059001.png)

### （3）关联文章分析

网址：[Finding Phish in a Haystack: A Pipeline for Phishing Classification on Certificate Transparency Logs | Connected Papers](https://www.connectedpapers.com/main/aa89cd84c557404797f2f999ed11710eee178517/Finding-Phish-in-a-Haystack-A-Pipeline-for-Phishing-Classification-on-Certificate-Transparency-Logs/graph)

![image-20210715184643858](Finding Phish in a Haystack A Pipeline for Phishing Classification on Certificate Transparency Logs.assets/image-20210715184643858.png)

### （4）文章背景

现在大多数网络钓鱼检测手段都利用被动式的屏蔽列表，这就给攻击者提供了一个攻击窗口（没有被加入屏蔽列表之前的一段时间）。通过监控**证书透明度（CT）日志**可以尽早检测出攻击，缩短这个窗口时间。

现有的使用CT日志进行网络钓鱼分类的工作缺乏对于真实CT日志数据的测试，作者解决了使用CT日志数据可能遇到的一些问题，提出了一种使用CT日志数据的管道（方案）。

管道包括：数据集的创建，训练，CT日志的历史或实时分类

这个管道具有模块化的结构使它能够方便地切换分类器或验证源，对分类器性能进行比较。

作者使用许多新的和现有的分类器进行了测试，并发现了针对此场景提升分类器性能地可能方法。

最后，作者将文章使用地数据集和管道的代码随文章一起发表，代码地址：

https://gitlab.com/rwth-itsec/ctl-pipeline?utm_source=catalyzex.com

两个问题：

1. CT日志中有大量的证书，这使得一个很低的误报率仍然会有大量错误分类
2. 缺乏具有可信标签的CT日志数据集

## 2.相关工作

网络钓鱼可以在诱饵分发的过程中检测，例如钓鱼邮件的检测；也可以检测钓鱼网站本身。不同的检测方法适用于不同的层面，并且可以组合使用。例如：钓鱼电子邮件检测可以防止钓鱼邮件到达用户的邮箱，网站检测可以防止用户点击链接后输入自己的信息。

`使用CT日志进行网络钓鱼的检测是在“诱饵”发送给用户前就进行检测，这就给防御网络钓鱼提供了另一个维度。优于证书通常包含多个域名，而域名也构成了一个URL的很大一部分，所以钓鱼URL检测和证书检测的任务有些重叠。因此，下面首先讨论钓鱼URL检测的现有方法，然后再讨论证书检测方法。`

url分类是自动检测钓鱼网站的一种流行方法：

1. Zhao等人[45]提出了一种仅在小的不平衡训练集上训练分类器的方法，仍然可以获得很高的分类精度。
2. Whittaker等人展示了一个分类器，它包含来自url和网站内容的特征，其目标是使用它来自动更新阻止列表。

`事实上，许多基于URL的解决方案使用其他来源的特性来补充URL特征，比如WHOIS信息或网站内容。包含额外的特征信息会提高分类性能和覆盖率，但对于CT日志中的证书不太可行，因为这些证书中不包含完整的URL。`

> 其中一些分类器还利用了来自网站证书的信息。例如，Mohammad等人在[27]的特性集中包括了HTTPS的使用，以及关于证书颁发者的信息。相应的数据集也已公开，并在其他几项研究中使用。
> 与url分类相比，证书提供的信息可能更少。尽管证书中有几个附加字段，但对于同一个颁发者[14]颁发的证书来说，它们通常非常相似或相同。因此，`嵌入在证书中的域名是首选特征`。但是，证书中的域包含的信息要比完整URL少得多，因为它们根本不包含路径信息，有时甚至在使用通配符证书时不包含所有子域。更有问题的是，网络钓鱼网站托管在已被破坏的基础设施上，在这种情况下，证书并不是出于恶意请求的。

只使用证书进行钓鱼检测的方法：

1. 2015年Dong等人提出了钓鱼网站证书的诸多特征，包括证书中不同领域的存在、长度、关系等。他们比较了一些分类器，这些分类器是在2012年底至2015年期间直接从已知钓鱼和良性网站收集的证书上训练的，发现随机森林(random forest, RF)分类器达到了最高的精度。
2. Scheitle等人[37]在2018年指出，CT日志可能为网络钓鱼检测提供一个新的视角。在对使用正则表达式的日志进行初步研究时，他们发现了大量的证书(超过125,000个)，它们很可能模拟了少量流行的服务，但没有包括深入的分析。
3. Torroledo等人[40]只针对证书训练钓鱼分类器，目的是检测钓鱼和非钓鱼证书合法性的差异。使用高度不平衡的数据集，它们达到了约90%的精度，作者在实验中无法重现或验证这一结论。
4. Fasllija等人[15]对从完整url中提取的域名进行了分类器训练，认为它也可以对CT日志进行分类。然而，他们没有进行测试。
5. 最近，Sakurai等人提出了一种专门用于CT日志分类的分类器。该分类器基于从已知钓鱼网站中提取的正则表达式，并在Censys[5]中收集到的证书上取得了良好的效果。然而，基于正则表达式的静态逻辑既不能检测带有未知域名模式的新的网络钓鱼活动，也不适合检测鱼饵式网络钓鱼活动，鱼饵式网络钓鱼活动一开始不会创建大量类似的域名。

本文作者提出了一种管道，使用实际CT日志数据对现存的和新的分类器进行测试，而且在证书被添加到日志中时，就可以对证书进行分类。为了与之前的工作进行对比，作者选取了Sakurai等人的分类器（直接对证书进行操作，且源代码开源）。

## 3.检测管道

### （1）设计目标

1. **数据处理：**为了对不同分类器的性能进行评估，对评估结果进行分析，管道必须可以处理来自不同源的不同类型的数据。这些源提供各种格式的数据，因此必须在聚合之前进行规范化。此外，汇总的数据可能包含重复的以及错误标记的样本，这些样本在使用前需要过滤掉。因此，第一个设计目标是确保有一种数据处理方法，能够适当地生成训练数据并对训练后的分类器进行评估。
2. **比较评估：**将新的方法与已有的分类器进行比较是研究过程中的一个重要部分。因此，第二个目标就是确保管道易于被其他研究人员重用，用于钓鱼证书检测分类器的比较分析。
3. **速度和可测量性：**CT日志具有大量的证书。因此，第三个目标是确保实时分类的可能性。此外，也要能够对大量历史数据进行分析。
4. 模块化和可扩展性：由于这一领域的研究进展迅速，第四个目标是确保已开发的管道组件可以方便替换，也就是模块化和低耦合性。

### （2）管道概况

检测管道包括四个独立的模块：

![image-20210716080201182](Finding Phish in a Haystack A Pipeline for Phishing Classification on Certificate Transparency Logs.assets/image-20210716080201182.png)

**数据库模块：**

负责收集，规范化，清洗，标注和存储来自不同源的不规范数据。

收集到的数据有两个用处：

* 用于训练模型和评估不同机器学习模型的性能
* 利用收集到的网络威胁情报来验证实时分类的结果，也可用于回顾性分析。

直接从CT日志中获得良性证书，由于日志中包含的证书数量非常大，所以将CT日志流划分为块，并定义了一个可以方便选择良性证书的API。图一中左上角阴影框表示选定的数据块，这样选择可以包含工作日和非工作日，一天内不同时间，一周内不同时间生成的证书日志。

![image-20210716144016296](Finding Phish in a Haystack A Pipeline for Phishing Classification on Certificate Transparency Logs.assets/image-20210716144016296.png)

由于主流浏览器要求证书必须有至少两个不同日志信息，所以可能会下载到重复的证书。所以数据库模块包括一个删除重复数据的过程。接着，使用一个网络钓鱼URL数据库过滤出良性证书，只要证书的CN(common name)和SAN(subject alternative name)字段匹配到钓鱼URL数据库，则删除该证书。CN和SAN字段hash匹配到谷歌安全浏览器的hash列表，也表明该证书是恶意的。

每隔一个小时从PhishTank和PhishStats获取新的谷歌安全浏览前缀和新的钓鱼url。每隔12小时从OpenPhish获取网络钓鱼url（免费接口12小时一次）。各种数据源的更新间隔是可调整的，并且可以很容易地添加新的数据源，因为作者已经定义了清晰的接口。对于已经包含的网络威胁情报馈送，实施了标准化方法，以便能够将数据存储在统一的数据库中，因为每个数据源提供的数据格式不同。

最后，允许针对恶意域列表过滤已获得的良性证书，该列表是可调的，以便能够过滤尚未(尚未)包含在观察到的网络威胁情报源中的已知恶意证书。目前，作者并没有利用这种过滤，因此恶意域名列表是空的。

使用OpenSSL[31]下载钓鱼URL数据库中包含的钓鱼URL证书，从而获得带有恶意标签的数据。

作者删除了所有重复的内容，并使用包含非常流行域的列表过滤了CN以及恶意证书中包含的每个SAN。具体来说，过滤了前1000个Alexa[1]和前1000个Tranco[22]域名。这种过滤的原因是，钓鱼网站不太可能是托管在非常流行的域名。

**训练模块：**

训练模块负责训练一个针对实时分类和历史分类的模型，可以使用监督学习和非监督学习，也可以是规则依赖的方法。

基于特征（SVM ,RF）和不基于特征(RNN, CNN)的训练都是可行的。

**分类模块：**

使用训练模块得出的模型对CT日志进行分类

**智能模块：**

智能模块对分类模块的结果进行验证和数据可视化。

## 4.新的和已存在的分类器

在这一节中，介绍了新开发的证书分类器和在相关工作中提出的最先进的分类器，在管道中对他们的分类性能进行测试。除了基于特征的分类器，作者还分析了深度学习分类器，以及两种最新的钓鱼证书检测方法。

### （1）域名分类

除通用名称(CN)外，证书通常还包括主题替代名称(SAN)字段中的多个域名。所以作者将单个证书的分类划分为多个域名的分类任务，使用元分类器对多个分类结果进行裁决。（注：域名分类器仍然使用域名和证书的特征，并不是仅使用域名特征）

裁决方法（元分类器）：

1. 最大值
2. 最小值
3. 平均值
4. 均值

### （2）特征工程，特征选择

基于相关工作中的分类器，深入分析良性证书和钓鱼证书来设计特征。作者只关注上下文无关的特征，即可以从单个证书中提取的特征。不从其它来源获取任何情报，以独立于第三方服务，并确保实时分类能力。

选取的特征可以分为三类：

1. 基于证书的特征：从证书提取的除了域名的信息
2. 基于域名的特征
3. 基于关键词的特征：可疑关键字列表是从PhishTank url中创建的，在删除公共后缀(顶级域名)后，通过分析被点分割的url部分。根据关键词出现的次数对候选关键词进行排序，并通过删除太短或太一般的词将列表减少到47个关键字。

总共有126个特征，22个基于证书，55个基于域名，49个基于关键字。

![image-20210716172543303](Finding Phish in a Haystack A Pipeline for Phishing Classification on Certificate Transparency Logs.assets/image-20210716172543303.png)

![image-20210716172611652](Finding Phish in a Haystack A Pipeline for Phishing Classification on Certificate Transparency Logs.assets/image-20210716172611652.png)

在进行特征工程之后，作者定义了两个不同的特征集。第一个特征集包含所有的特征，作为对照组。`第二个特征集是通过对前两个类别的特征进行特征选择来创建的，以确保只包含与分类过程实际相关的特征。`此外，减少特征的数量也减少了提取特征所需的时间，并可以改进分类器，使其对噪声的鲁棒性更好。此特性集限制为前两类特性的子集，从不包含基于关键字的特性，这样做可以使模型的实用性更好。

特征选择：通过训练一个随机森林分类器进行特征选择，并根据不纯度平均减少（MDI）对特征的重要性进行排序，然后排除不重要或表现出高方差的特性。

### （3）随机森林分类器

首先在管道中使用随机森林分类器进行测试。过去的工作已经证明，RF分类器非常适合钓鱼网站的分类问题。对于这两个特征及（全部和选定），使用四个元分类器，也就是说总共有8个要评估分类器。对于所有基于RF的分类器，使用默认超参数(由scikit-learn[32]设置)，但将估计数增加到200。

### （4）深度学习分类器

为了对上述基于特征的模型和深度学习模型进行比较，作者创建了一个基于RNN（循环神经网络）的分类器。

基于RNN的分类器不需要进行特征工程，但是必须对与分类相关的信息进行编码并提供给分类器。因此，作者利用所有特征作为一种证书编码，并将此信息提供给模型。此外，使用字符整数编码向模型提供原始域名。通过选择这种方法，神经网络可以(1)学习从域名中提取相关信息，(2)从自身提供的所有特征中选择相关信息.

![image-20210716201150010](Finding Phish in a Haystack A Pipeline for Phishing Classification on Certificate Transparency Logs.assets/image-20210716201150010.png)

### (5)使用一个分类器对域名进行分类

在4.1节中，使用域名分类器有和元分类器进行分类，这里使用单一分类器对证书进行分类。

在这种方法中，作者提取证书中包含的每个独立域名的特征，并创建一个新的特征向量，该特征向量包含每个特征的域名特征向量的平均值。

### （6）相关工作的最新分类器

* 第一个分类器是Sakurai等人的[36]，它只使用域名作为输入，`并自动创建匹配相同模式的恶意域名的正则表达式`。这个分类器不返回0到1之间的分类分数，它只返回与给定域匹配的表达式的信息。因此，作者修改其输出，返回所有匹配表达式中最大的熵约简率(见[36])作为分类得分。由于该分类器的设计目的是寻找恶意域，而不是证书，因此在组合证书的分类得分时返回匹配域的最高得分，对应使用最大元分类器。
* Phishing Catcher[44]，这是一个基于规则的证书分类器，其中每个规则都可能增加分类得分。例如，规则包括在任何域名中包含可疑的关键字，或使用可疑的顶级域名。唯一的非域特定特性表明，证书的颁发者是否与流行的免费证书颁发机构Let s Encrypt匹配。`与其他分类器相比，它的独特之处在于它不需要任何训练，因为它完全基于基于领域知识的启发式。`作者修改了这个分类器，以返回0到1之间的分数，而不是打印可疑域的消息。

## 5.评估测试

5.1节主要测试不同分类方法区分良性证书和钓鱼证书的能力，5.2节评估管道是否满足了设计目标。

### （1）分类器测试

**数据集：**

`恶意标记的训练数据：`作者使用数据库模块(参见3.2.1节)生成恶意标记的训练数据。具体来说，通过2019年全年每天下载PhishTank URL feed来获取恶意证书。此外，还通过每小时下载一次PhishTank和PhishStats的源文件，以及在2020年1月至5月期间每12小时下载一次OpenPhish的源文件，进一步收集恶意证书。总共收集了56,479个唯一的恶意证书。

`良性标记的训练数据：`作者通过数据库模块获得良性标记的训练数据。下载了从2020年4月开始的谷歌Xenon[16]日志证书。这些日志是在编写时进展最快的CT日志。总共下载了70,889个唯一的良性证书，从中随机选择了56,479个证书(与恶意证书数量相同)用于训练过程。

作者在之前的实验中，曾尝试使CT测试集的数据更加接近实际分布，为此测试了不同的不平衡数据分布。但是没有发现明显差异，因此在本次实验中作者使用的是一个平衡的数据集。

---

使用训练集进行训练，测试使用的是真实世界的CT日志数据。

**实验结果：**

从训练数据中分离出一小部分用于验证集，用于基于深度学习方法，或基于RF方法的训练之后，用于模型评估目的。基于深度学习的模型进行训练，直到至少连续三个阶段验证集没有进一步改进为止。

选择假阳性率(FPR)和真阳性率(TPR)作为评价指标，这是特别适合于高度不平衡数据[10]的度量。由于日志中良性证书的数量远大于网络钓鱼证书，而且证书的数量一般都很大，低FPR是合适分类器的最重要属性。TPR是确定被检测到的钓鱼证书数量的表征。

在下图中，展示了对四个元分类器中的每一个进行域RFall分类器(即使用所有工程特征的基于rf的域分类器)训练后得到特征曲线。

![image-20210716204642404](Finding Phish in a Haystack A Pipeline for Phishing Classification on Certificate Transparency Logs.assets/image-20210716204642404.png)

因为实际CT日志数据非常大，所以要求FPR很低，所以最小和平均值方法比较好。

将FPR设定为0.001或0.0001：

![image-20210716211219411](Finding Phish in a Haystack A Pipeline for Phishing Classification on Certificate Transparency Logs.assets/image-20210716211219411.png)

在FPR固定为0.001的情况下，基于规则的分类器Phishing Catcher取得了迄今为止最好的结果。在FPR为0.0001时，Sakurai等人的分类器检测到最多的钓鱼证书，其次是Phishing Catcher。作者开发的基于RF和基于RNN的方法的结果则不尽人意。这是由训练噪声引起的。

> 由于作者从各种OSINT提要中包含的url中下载证书，从而获得了带有恶意标签的样本和良性证书，这些证书被用于存在于受威胁的服务器基础设施上的钓鱼网站。尽管我们根据良性域名列表过滤了这些证书，但仍相当数量的良性证书被错误地标记为恶意的。据估计，62% 73%的钓鱼网站实际上是在被破坏的基础设施上托管的[20,21]。
>
> 这就是为什么Sakurai等人和Phishing Catcher的方法比机器学习分类器的性能稍好。Phishing Catcher只使用由领域专家创建的规则，因此不受受损害的服务器证书的影响。另一方面，Sakurai等人提出的分类器，基于生成的正则表达式来匹配遵循相同模式的恶意域，对样本进行分类。虽然这个分类器是在相同的噪声数据上训练的，但它对分类性能的影响很小。

### （2）管道测试

管道是否满足3.1节中定义的设计目标？

1. 数据处理：提出的管道能够从不同的数据源收集、规范化、合并、过滤和标签数据。因此，管道能够处理不同格式和来自不同数据源的复杂数据。
2. 比较评估：在5.1节中，已经对几种自行开发的分类器以及相关工作中提出的分类器进行了比较评价。
3. 速度和可测量性：在Intel Xeon Platinum 8160 processor@2.1 GHz的24个核上执行使用RF分类和所有四种不同元分类器的单一管道执行，这大约需要55gb RAM。因此，管道能够在将发布在CT日志中的大量证书添加到日志中时处理它们。
4. 模块化和可扩展性：管道设计的非常模块化，并定义了清晰的接口。

## 6. 总结

这项工作的主要`焦点在于检测管道本身，而不是开发最好的钓鱼证书检测分类器`。在文中的比较评估中，作者展示了各种类型的分类器，如基于特征的、基于深度学习的和基于规则的方法，可以在管道中使用。虽然结果表明，管该道可以实时分析多个CT日志，甚至可以在相应的钓鱼网站被激活之前检测钓鱼证书，但分类器需要未来的研究。

虽然该方法能够检测有意为钓鱼网站创建的证书，`但无法检测托管在受威胁的服务器基础设施上的钓鱼网站使用的良性证书`（不足之处）。未来的工作可以改进在创建恶意标记训练数据时的过滤过程，以获得更少的噪声数据。不幸的是，当分类仅仅依赖于从单个证书中获得的信息时，检测在被破坏的服务器基础设施上的钓鱼网站上使用的证书可能是不可能的。

